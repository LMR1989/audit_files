# This script is Copyright (C) 2004-2021 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#
# VMware KB - https://kb.vmware.com/s/article/83829
# Tenable: cve-2021-21985-critical-vmware-vcenter-server-remote-code-execution - https://www.tenable.com/blog/cve-2021-21985-critical-vmware-vcenter-server-remote-code-execution
#
# Note: This .audit can only be scanned against vCenter Server targets which have bash shell configured as the default shell. - https://kb.vmware.com/s/article/2100508

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      type        : CMD_EXEC
      description : "Check for vulnerable vCenter version"
      cmd         : "/usr/sbin/vpxd -v"
      expect      : "VMware VirtualCenter (6\.5\.0 build-([456789][0-9]{6}|1([0123456][0-9]{6}|7[57][0-9]{5}))|6\.7\.0 build-([89][0-9]{6}|1[0134567][0-9]{6})|7\.0\.[012] build-1([56][0-9]{6}|7([0346][0-9]{5}|92[0-9]{4})))"
    </custom_item>
  </condition>

  <then>
    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware Site Recovery plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware Site Recovery plugin must be set to 'incompatible' in /etc/vmware/vsphere-ui/compatibility-matrix.xml. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id=\"com.vmware.vrops.install\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vsphere.client.h5vsan\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vrUi\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vum.client\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.h4.vsphere.client\" status=\"incompatible\"/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      file        : "/etc/vmware/vsphere-ui/compatibility-matrix.xml"
      regex       : "^[\\s]*\<PluginPackage id=\"com.vmware.vrUi\""
      expect      : "\<PluginPackage id=\"com.vmware.vrUi\" status=\"incompatible\"/>"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware vSphere Lifecycle Manager plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware vSphere Lifecycle Manager plugin must be set to 'incompatible'. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <\-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id=\"com.vmware.vrops.install\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vsphere.client.h5vsan\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vrUi\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vum.client\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.h4.vsphere.client\" status=\"incompatible\"/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      file        : "/etc/vmware/vsphere-ui/compatibility-matrix.xml"
      regex       : "^[\\s]*\<PluginPackage id=\"com.vmware.vum.client\""
      expect      : "\<PluginPackage id=\"com.vmware.vum.client\" status=\"incompatible\"/>"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware Site Recovery plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware Site Recovery plugin must be set to 'incompatible'. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <\-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id=\"com.vmware.vrops.install\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vsphere.client.h5vsan\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vrUi\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.vum.client\" status=\"incompatible\"/>
  <PluginPackage id=\"com.vmware.h4.vsphere.client\" status=\"incompatible\"/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      file        : "/etc/vmware/vsphere-ui/compatibility-matrix.xml"
      regex       : "^[\\s]*\<PluginPackage id=\"com.vmware.h4.vsphere.client\""
      expect      : "^[\\s]*\<PluginPackage id=\"com.vmware.h4.vsphere.client\" status=\"incompatible\"/>"
    </custom_item>
  </then>

  <else>
    <report type:"PASSED">
      description : "CVE-2021-21986 does not apply to this vCenter Server version/build."
      info        : "CVE-2021-21986 does not apply to this vCenter Server version/build."
      see_also    : "https://kb.vmware.com/s/article/83829"
    </report>
  </else>
</if>

</check_type>
