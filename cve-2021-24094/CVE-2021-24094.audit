# This script is Copyright (C) 2004-2021 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#   https://msrc-blog.microsoft.com/2021/02/09/multiple-security-updates-affecting-tcp-ip/
#   https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-24094
#   https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-24094

<check_type:"Windows" version:"2">
<group_policy:"Windows">

<if>
  <condition type:"AND">
    <custom_item>
      type        : REGISTRY_SETTING
      description : "IPv6 is disabled"
      value_type  : POLICY_DWORD
      value_data  : "255"
      reg_key     : "HKLM\SYSTEM\CurrentControlSet\Services\TCPIP6\Parameters"
      reg_item    : "DisabledComponents"
      reg_option  : CAN_NOT_BE_NULL
    </custom_item>
  </condition>

  <then>
    <report type:"PASSED">
      description : "IPv6 is disabled on target and CVE-2021-24094 does not apply."
      info        : "IPv6 is disabled on target and CVE-2021-24094 does not apply."
    </report>
  </then>

  <else>
    <custom_item>
      type            : AUDIT_POWERSHELL
      description     : "CVE-2021-24094 - Check if ReassemblyLimit is set to '0'."
      info            : "This check looks for the existence of a temporary workaround advised by Microsoft for a Critical Remote Code Execution (RCE) vulnerability until CVE-2021-24094 patches are in place."
      solution        : "Set global reassemblylimit to 0

The following command disables packet reassembly. Any out-of-order packets are dropped. Valid scenarios should not exceed more than 50 out-of-order fragments. We recommend testing prior to updating production systems.

Netsh int ipv6 set global reassemblylimit=0"
      see_also        : "https://msrc-blog.microsoft.com/2021/02/09/multiple-security-updates-affecting-tcp-ip/"
      value_type      : POLICY_TEXT
      value_data      : "ReassemblyLimit[\s]*:[\s]*0"
      powershell_args : "Get-NetIPv6Protocol | SELECT 'ReassemblyLimit' | Format-List"
      check_type      : CHECK_REGEX
    </custom_item>
  </else>
</if>

</group_policy>
</check_type>
