# This s# T# This script is Copyright (C) 2004-2021 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#
# VMware KB - https://kb.vmware.com/s/article/83829
# Tenable: cve-2021-21985-critical-vmware-vcenter-server-remote-code-execution - https://www.tenable.com/blog/cve-2021-21985-critical-vmware-vcenter-server-remote-code-execution

<check_type:"Windows" version:"2">
<group_policy:"Windows">

<if>
  <condition type:"AND">
    <custom_item>
      type            : AUDIT_POWERSHELL
      description     : "Check for vulnerable vCenter version"
      powershell_args : "Get-WmiObject -Class Win32_Product | where name -eq 'VMware vCenter Server' | select Version | format-table -hidetableheaders"
      value_type      : POLICY_TEXT
      value_data      : "(6\.(5\.0\.([0-2][0-9]{4}|3[0-4][0-9]{3})|7\.0\.([1-3][0-9][0-9]{3}|4[0-7]{4}))|7\.0\.([01]\.[01]0[0123467]00|2\.00[01]00))"
      check_type      : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware Site Recovery plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware Site Recovery plugin must be set to 'incompatible' in C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id='com.vmware.vrops.install' status='incompatible'/>
  <PluginPackage id='com.vmware.vsphere.client.h5vsan' status='incompatible'/>
  <PluginPackage id='com.vmware.vrUi' status='incompatible'/>
  <PluginPackage id='com.vmware.vum.client' status='incompatible'/>
  <PluginPackage id='com.vmware.h4.vsphere.client' status='incompatible'/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      value_type  : POLICY_TEXT
      value_data  : "C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml"
      regex       : 'com.vmware.vrUi'
      expect      : '<PluginPackage id="com.vmware.vrUi" status="incompatible"/>'
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware vSphere Lifecycle Manager plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware vSphere Lifecycle Manager plugin must be set to 'incompatible' in C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id='com.vmware.vrops.install' status='incompatible'/>
  <PluginPackage id='com.vmware.vsphere.client.h5vsan' status='incompatible'/>
  <PluginPackage id='com.vmware.vrUi' status='incompatible'/>
  <PluginPackage id='com.vmware.vum.client' status='incompatible'/>
  <PluginPackage id='com.vmware.h4.vsphere.client' status='incompatible'/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      value_type  : POLICY_TEXT
      value_data  : "C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml"
      regex       : 'com.vmware.vum.client'
      expect      : '<PluginPackage id="com.vmware.vum.client" status="incompatible"/>'
    </custom_item>

    <custom_item>
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-21986 - Check if the VMware Site Recovery plugin has been set to 'incompatible'"
      info        : "This check looks for the existence of a temporary workaround advised by VMware for a vulnerability in the VMware Site Recovery plugin shipped with vCenter Server until CVE-2021-21986 patches are in place."
      solution    : "The VMware Site Recovery plugin must be set to 'incompatible' in C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml. Disabling the plugin from within the UI will not protect the system from this vulnerability.

To disable all plugins with disclosed vulnerabilities, add the following lines as shown below:
Note: These entries should be added between the --> and <-- entries between WHITE LIST and BLACK LIST.

  <PluginPackage id='com.vmware.vrops.install' status='incompatible'/>
  <PluginPackage id='com.vmware.vsphere.client.h5vsan' status='incompatible'/>
  <PluginPackage id='com.vmware.vrUi' status='incompatible'/>
  <PluginPackage id='com.vmware.vum.client' status='incompatible'/>
  <PluginPackage id='com.vmware.h4.vsphere.client' status='incompatible'/>"
      see_also    : "https://kb.vmware.com/s/article/83829"
      value_type  : POLICY_TEXT
      value_data  : "C:\ProgramData\VMware\vCenterServer\cfg\vsphere-ui\compatibility-matrix.xml"
      regex       : 'com.vmware.h4.vsphere.client'
      expect      : '<PluginPackage id="com.vmware.h4.vsphere.client" status="incompatible"/>'
    </custom_item>
  </then>

  <else>
    <report type:"PASSED">
      description : "CVE-2021-21986 does not apply to this vCenter Server version/build."
      info        : "CVE-2021-21986 does not apply to this vCenter Server version/build."
      see_also    : "https://kb.vmware.com/s/article/83829"
    </report>
  </else>
</if>

</check_type>
