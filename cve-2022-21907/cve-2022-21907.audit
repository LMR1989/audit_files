#
# This script is Copyright (C) 2004-2022 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#   https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907
#
#<ui_metadata>
#<display_name>HTTP Protocol Stack Remote Code Execution Vulnerability</display_name>
#<spec>
#  <type>TNS</type>
#  <name>HTTP Protocol Stack Remote Code Execution Vulnerability</name>
#  <version>1.0.0</version>
#  <link>https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907</link>
#</spec>
#<labels>windows,tns</labels>
#</ui_metadata>

<check_type:"Windows" version:"2">
<group_policy:"CVE-2022-21907">

<if>
  <condition type:"AND">
    <custom_item>
      type        : REGISTRY_SETTING
      description : "Windows Server 2019 is installed"
      value_type  : POLICY_TEXT
      value_data  : "^[a-zA-Z0-9\(\)\s]*2019[\s]*[a-zA-Z0-9\(\)\s:]*$"
      reg_key     : "HKLM\Software\Microsoft\Windows Nt\Currentversion"
      reg_item    : "ProductName"
      check_type  : CHECK_REGEX
    </custom_item>
  </condition>

  <then>
    <custom_item>
      type        : REGISTRY_SETTING
      description : "CVE-2022-21907 - HTTP Protocol Stack Remote Code Execution Vulnerability"
      info        : "According to the latest announcement issued by the Microsoft Security Response Center, Microsoft has issued a patch for a high-severity vulnerability found in Windows Server 2019 and Windows 10 in the latest cumulative update. The vulnerability ID is CVE-2022-21907, and the vulnerability can be exploited by sending specially crafted packets to exploit the HTTP protocol stack to launch an attack. Enterprise Administrators can also use the registry to disable certain inactive features to improve security if the lates cumulative update cannot be installed in a timely manner to fix the vulnerability. This mitigation applies to Windows Server version 2019 and Windows 10 (1809) and specifically disables the Trailer interface via the registry, which is used for HTTP header functionality."
      reference   : "CVE|CVE-2022-21907"
      see_also    : "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907"
      value_type  : POLICY_DWORD
      value_data  : 0
      reg_key     : "HKLM\System\Currentcontrolset\Services\Http\Parameters"
      reg_item    : "EnableTrailerSupport"
      reg_option  : CAN_BE_NULL
    </custom_item>
  </then>

  <else>
    <if>
      <condition type:"AND">
        <custom_item>
          type        : REGISTRY_SETTING
          description : "Windows 10 is installed"
          value_type  : POLICY_TEXT
          value_data  : "^[Ww][Ii][Nn][Dd][Oo][Ww][Ss] 10.+$"
          reg_key     : "HKLM\Software\Microsoft\Windows Nt\Currentversion"
          reg_item    : "ProductName"
          check_type  : CHECK_REGEX
        </custom_item>

        <custom_item>
          type        : REGISTRY_SETTING
          description : "Check Windows Release"
          value_type  : POLICY_TEXT
          value_data  : "1809"
          reg_key     : "HKLM\Software\Microsoft\Windows Nt\Currentversion"
          reg_item    : "ReleaseId"
          check_type  : CHECK_REGEX
        </custom_item>
      </condition>

      <then>
        <custom_item>
          type        : REGISTRY_SETTING
          description : "CVE-2022-21907 - HTTP Protocol Stack Remote Code Execution Vulnerability"
          info        : "According to the latest announcement issued by the Microsoft Security Response Center, Microsoft has issued a patch for a high-severity vulnerability found in Windows Server 2019 and Windows 10 in the latest cumulative update. The vulnerability ID is CVE-2022-21907, and the vulnerability can be exploited by sending specially crafted packets to exploit the HTTP protocol stack to launch an attack. Enterprise Administrators can also use the registry to disable certain inactive features to improve security if the lates cumulative update cannot be installed in a timely manner to fix the vulnerability. This mitigation applies to Windows Server version 2019 and Windows 10 (1809) and specifically disables the Trailer interface via the registry, which is used for HTTP header functionality."
          reference   : "CVE|CVE-2022-21907"
          see_also    : "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907"
          value_type  : POLICY_DWORD
          value_data  : 0
          reg_key     : "HKLM\System\Currentcontrolset\Services\Http\Parameters"
          reg_item    : "EnableTrailerSupport"
          reg_option  : CAN_BE_NULL
        </custom_item>
      </then>

      <else>
        <report type:"PASSED">
          description : "CVE-2022-21907 - HTTP Protocol Stack Remote Code Execution Vulnerability"
          info        : "NOTE: Nessus has not identified that the CVE-2022-21907 mitigations apply to the target device."
          see_also    : "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907"
        </report>
      </else>
    </if>
  </else>
</if>

</group_policy>
</check_type>
