#
# This script is Copyright (C) 2004-2021 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#   https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/
#
#<ui_metadata>
#<display_name>ProxyNotShell Unsupported Mitigation Detection</display_name>
#<spec>
#  <type>TNS</type>
#  <name>ProxyNotShell Unsupported Mitigation Detection</name>
#  <version>1.0.0</version>
#  <link>https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/</link>
#</spec>
#<labels>windows,exchange,exchange_server,cve-2022-41040,cve-2022-41082</labels>
#</ui_metadata>

<check_type:"Windows" version:"2">
<group_policy:"Microsoft IIS Exchange Server">

<if>
  <condition type:"AND">
    <custom_item>
      type        : REG_CHECK
      description : "Exchange Server is installed"
      value_type  : POLICY_TEXT
      value_data  : "HKLM\Software\Microsoft\ExchangeServer"
      reg_option  : MUST_EXIST
    </custom_item>
  </condition>

  <then>
    <if>
      <condition type:"AND">
        <custom_item>
          type        : AUDIT_IIS_APPCMD
          description : "Test if mitigations are in place"
          value_type  : POLICY_TEXT
          value_data  : 'pattern:\\"\\(\\?\\=\\.\\*autodiscover\\)\\(\\?\\=\\.\\*powershell\\)\\"'
          appcmd_args : "list config {} /section:system.webServer/rewrite/rules /text:*"
          appcmd_list : "list sites"
          check_type  : CHECK_REGEX
        </custom_item>
      </condition>

      <then>
        <report type:"FAILED">
          description : "CVE-2022-41040/CVE-2022-41082 - ProxyNotShell Mitigation Detection"
          info        : "The unsupported ProxyNotShell mitigations have been detected on the target. Microsoft no longer recommends the mitigation solution for the ProxyNotShell vulnerability. It is strongly recommended that users apply the Exchange Server security updates for CVE-2022-41040 and CVE-2022-41082."
          solution    : "Remove the URL rewrite rule that is found in IIS Manager:

          Open IIS Manager.

          Click the site name.

          In the Feature View, click URL Rewrite.

          Select the URL Rewrite Rule.

          Then select 'Remove' from the 'Inbound Rules' found in the right side column.

          Lastly, ensure the Microsoft Security Updates for the vulnerabilities have been applied.

          The security updates can be detected using the following Tenable Vulnerability Plugins:

          https://www.tenable.com/cve/CVE-2022-41040

          https://www.tenable.com/cve/CVE-2022-41082"
          reference   : "CVE|CVE-2022-41040,CVE|CVE-2022-41082"
          see_also    : "https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/"
        </report>
      </then>

      <else>
        <report type:"PASSED">
          description : "CVE-2022-41040/CVE-2022-41082 - ProxyNotShell Mitigation Detection"
          info        : "The unsupported ProxyNotShell mitigations have not been detected on the target. Microsoft no longer recommends the mitigation solution for the ProxyNotShell vulnerability. It is strongly recommended that users apply the Exchange Server security updates for CVE-2022-41040 and CVE-2022-41082."
          solution    : "The ProxyNotShell mitigations were not detected on the target. However, this DOES NOT imply that the target is secure from the ProxyNotShell vulnerablity.

          Please ensure the Microsoft Security Updates for the vulnerabilities have been applied.

          The security updates can be detected using the following Tenable Vulnerability Plugins:

          https://www.tenable.com/cve/CVE-2022-41040

          https://www.tenable.com/cve/CVE-2022-41082"
          reference   : "CVE|CVE-2022-41040,CVE|CVE-2022-41082"
          see_also    : "https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/"
        </report>
      </else>
    </if>
  </then>

  <else>
    <report type:"WARNING">
      description : "CVE-2022-41040/CVE-2022-41082 - ProxyNotShell Mitigation Detection"
      info        : "NOTE: Nessus has not identified that the CVE-2022-41040/CVE-2022-41082 mitigations apply to the target device."
      see_also    : "https://msrc-blog.microsoft.com/2022/09/29/customer-guidance-for-reported-zero-day-vulnerabilities-in-microsoft-exchange-server/"
    </report>
  </else>
</if>

</group_policy>
</check_type>
