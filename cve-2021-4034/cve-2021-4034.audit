#
# This script is Copyright (C) 2004-2022 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit detects the audit rule is in place to help detect the local privilege escalation vulnerability found in polkit's pkexec.
#
# Sources for additional information:
#   https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034
#
#<ui_metadata>
#<display_name>Local Privilege Escalation Vulnerability Discovered in polkit's pkexec</display_name>
#<spec>
#  <type>TNS</type>
#  <name>Local Privilege Escalation Vulnerability Discovered in polkit's pkexec</name>
#  <version>1.0.0</version>
#  <link>https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034</link>
#</spec>
#<labels>unix,tns</labels>
#</ui_metadata>

<check_type:"Unix">

<if>
  <condition type:"AND">
    <custom_item>
      system      : "Linux"
      type        : FILE_CONTENT_CHECK
      description : "CVE-2021-4034 - Local Privilege Escalation Vulnerability Discovered in polkit's pkexec - audit rules"
      file        : "/etc/audit/audit.rules"
      regex       : "^[\\s]*-w[\\s]+/usr/bin/pkexec[\\s]+-p[\\s]+x[\\s]+-k[\\s]+pkexec[\\s]*$"
      expect      : "^[\\s]*-w[\\s]+/usr/bin/pkexec[\\s]+-p[\\s]+x[\\s]+-k[\\s]+pkexec[\\s]*$"
    </custom_item>

    <custom_item>
      system      : "Linux"
      type        : CMD_EXEC
      description : "CVE-2021-4034 - Local Privilege Escalation Vulnerability Discovered in polkit's pkexec - auditctl"
      cmd         : "/usr/sbin/auditctl -l | /usr/bin/grep -E '^[\\s]*-w[\\s]+/usr/bin/pkexec[\\s]+-p[\\s]+x[\\s]+-k[\\s]+pkexec[\\s]*$'  | /usr/bin/awk '{print} END {if (NR != 0) print \"pass\" ; else print \"fail\"}'"
      expect      : "pass"
    </custom_item>
  </condition>

  <then>
    <report type:"WARNING">
      description : "CVE-2021-4034 - Local Privilege Escalation Vulnerability Discovered in polkit's pkexec - audit rules"
      info        : "A memory corruption vulnerability CVE-2021-4034 in PolKit, a component used in major Linux distributions and some Unix-like operating systems, can be easily exploited by local unprivileged users to gain full root privileges.

  NOTE: Nessus detected the audit rule is in place which may indicate the privilege escalation from CVE-2021-4034."
      solution    : "It is highly recommended that affected users update the poolkit package once it is available. The issue can be mitigated by  executing the following steps:

1. Install the following required systemtap packages and dependencies: https://access.redhat.com/solutions/5441.

2. Install polkit debug info:

debuginfo-install polkit

3. Create the following systemtap script, and name it pkexec-block.stp:

probe process(\"/usr/bin/pkexec\").function(\"main\") {

if (cmdline_arg(1) == \"\")

raise(9);

}

4. Load the systemtap module into the running kernel:

stap -g -F -m stap_pkexec_block pkexec-block.stp

5. Ensure the module is loaded:

lsmod | grep -i stap_pkexec_block

stap_pkexec_block 434176 0

6. Once the polkit package is updated to the version containing the fix, remove the systemtap generated kernel module by running:

rmmod stap_pkexec_block

After using the rmmod command, a system reboot isn't required. "
      reference   : "CVE|CVE-2021-4034"
      see_also    : "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034"
    </report>
  </then>

  <else>
    <report type:"FAILED">
      description : "CVE-2021-4034 - Local Privilege Escalation Vulnerability Discovered in polkit's pkexec - audit rules"
      info        : "A memory corruption vulnerability CVE-2021-4034 in PolKit, a component used in major Linux distributions and some Unix-like operating systems, can be easily exploited by local unprivileged users to gain full root privileges.

  NOTE: Nessus DID NOT detect the audit rule is in place which may indicate the privilege escalation from CVE-2021-4034."
      solution    : "It is highly recommended that affected users update the poolkit package once it is available. The issue can be mitigated by  executing the following steps:

1. Install the following required systemtap packages and dependencies: https://access.redhat.com/solutions/5441.

2. Install polkit debug info:

debuginfo-install polkit

3. Create the following systemtap script, and name it pkexec-block.stp:

probe process(\"/usr/bin/pkexec\").function(\"main\") {

if (cmdline_arg(1) == \"\")

raise(9);

}

4. Load the systemtap module into the running kernel:

stap -g -F -m stap_pkexec_block pkexec-block.stp

5. Ensure the module is loaded:

lsmod | grep -i stap_pkexec_block

stap_pkexec_block 434176 0

6. Once the polkit package is updated to the version containing the fix, remove the systemtap generated kernel module by running:

rmmod stap_pkexec_block

After using the rmmod command, a system reboot isn't required. "
      reference   : "CVE|CVE-2021-4034"
      see_also    : "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034"
    </report>
  </else>
</if>

</check_type>
