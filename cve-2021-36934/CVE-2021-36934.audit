# This script is Copyright (C) 2004-2021 and is owned by Tenable, Inc. or an Affiliate thereof.
#
# This .audit addresses a temporary stop gap in targets where the patch is not installed or feasible to install in a timely manner.
#
# Sources for additional information:
#   https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934
#
<check_type:"Windows" version:"2">
<group_policy:"CVE-2021-36934">

<custom_item>
  type            : AUDIT_POWERSHELL
  description     : "CVE-2021-36934 - %windir%\system32\config\SAM"
  info            : "This check looks for the existence of a temporary workaround advised by Microsoft until CVE-2021-36934 patches are in place."
  solution        : "From https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934:

An elevation of privilege vulnerability exists because of overly permissive Access Control Lists (ACLs) on multiple system files, including the Security Accounts Manager (SAM) database. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.

Workarounds
Restrict access to the contents of %windir%\system32\config

Open Command Prompt or Windows PowerShell as an administrator.

Run this command: icacls %windir%\system32\config\*.* /inheritance:e

Delete Volume Shadow Copy Service (VSS) shadow copies

Delete any System Restore points and Shadow volumes that existed prior to restricting access to %windir%\system32\config.

Create a new System Restore point (if desired).

Impact of workaround Deleting shadow copies could impact restore operations, including the ability to restore data with third-party backup applications.

Note You must restrict access and delete shadow copies to prevent exploitation of this vulnerability."
  value_type      : POLICY_TEXT
  value_data      : "PASSED.*"
  powershell_args : "$acls = (icacls '%windir%\system32\config\SAM') ; $status = 'PASSED' ; foreach ($acl in $acls) { if (!$acl) { continue } elseif ($acl -like '*BUILTIN\Users:(I)(RX)') { $status = 'FAILED' } } $acls ; '' ; 'STATUS: '+$status"
  check_type      : CHECK_REGEX
</custom_item>

<custom_item>
  type            : AUDIT_POWERSHELL
  description     : "CVE-2021-36934 - Volume Shadow Copy service status"
  info            : "This check is for reporting the status of the Volume Shadow Copy service on this target."
  solution        : "From https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934:

An elevation of privilege vulnerability exists because of overly permissive Access Control Lists (ACLs) on multiple system files, including the Security Accounts Manager (SAM) database. An attacker who successfully exploited this vulnerability could run arbitrary code with SYSTEM privileges. An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights.

Workarounds
Restrict access to the contents of %windir%\system32\config

Open Command Prompt or Windows PowerShell as an administrator.

Run this command: icacls %windir%\system32\config\*.* /inheritance:e

Delete Volume Shadow Copy Service (VSS) shadow copies

Delete any System Restore points and Shadow volumes that existed prior to restricting access to %windir%\system32\config.

Create a new System Restore point (if desired).

Impact of workaround Deleting shadow copies could impact restore operations, including the ability to restore data with third-party backup applications.

Note You must restrict access and delete shadow copies to prevent exploitation of this vulnerability."
  value_type      : POLICY_TEXT
  value_data      : "Manual Review Required"
  powershell_args : "Get-Service | Where {$_.Name -like 'VSS'}"
  severity        : MEDIUM
</custom_item>

</group_policy>
</check_type>
